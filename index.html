<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "<VOTRE_API_KEY>",
  authDomain: "<VOTRE_PROJECT_ID>.firebaseapp.com",
  projectId: "<VOTRE_PROJECT_ID>",
  storageBucket: "<VOTRE_PROJECT_ID>.appspot.com",
  messagingSenderId: "<VOTRE_SENDER_ID>",
  appId: "<VOTRE_APP_ID>"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- AJOUT PRODUIT AVEC CLOUDINARY ---
formProduit.onsubmit = async e => {
  e.preventDefault();

  if (!vendeurConnecte) {
    alert("Connectez-vous en tant que vendeur !");
    return;
  }

  const file = imageProduit.files[0];
  if (!file) { alert("Veuillez sélectionner une image."); return; }

  try {
    // Préparer l'image pour Cloudinary
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "ml_default"); // vérifier preset dans Cloudinary

    // Upload Cloudinary
    const res = await axios.post(
      "https://api.cloudinary.com/v1_1/dmwrnpkhw/image/upload",
      formData
    );

    const imageUrl = res.data.secure_url;

    // Préparer le produit
    const produit = {
      nom: nomProduit.value,
      description: descProduit.value,
      prix: parseFloat(prixProduit.value),
      image: imageUrl,
      vendeur: vendeurConnecte.username,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Ajouter dans Firestore
    await db.collection("produits").add(produit);

    alert("Produit ajouté avec succès !");
    
    // Réinitialiser le formulaire
    formProduit.reset();

    // Rafraîchir l'affichage des produits
    chargerProduitsFirestore();

  } catch (err) {
    console.error(err);
    alert("Erreur lors de l'ajout du produit !");
  }
};

// --- CHARGEMENT PRODUITS FIRESTORE ---
async function chargerProduitsFirestore() {
  const c = document.getElementById("produits-container");
  c.innerHTML = "";

  const snapshot = await db.collection("produits").orderBy("createdAt", "desc").get();
  snapshot.forEach(doc => {
    const p = doc.data();
    c.innerHTML += `<div class="produit">
      <img src="${p.image}">
      <h4>${p.nom}</h4>
      <p>${p.prix} FG</p>
      <button onclick="ajouterAuPanierFirestore('${doc.id}')">Ajouter au panier</button>
      <button onclick="commanderDirectFirestore('${doc.id}')">Commander maintenant</button>
    </div>`;
  });
}

// --- PANIER FIRESTORE ---
let panier = []; // local stockage toujours ok
async function ajouterAuPanierFirestore(docId) {
  const doc = await db.collection("produits").doc(docId).get();
  panier.push({id: docId, ...doc.data()});
  afficherPanier();
  showSection("panier-section");
}

async function commanderDirectFirestore(docId) {
  const doc = await db.collection("produits").doc(docId).get();
  panier = [{id: docId, ...doc.data()}];
  afficherPanier();
  showSection("panier-section");
}

// --- AU CHARGEMENT ---
window.onload = () => {
  chargerProduitsFirestore();
};
  </script>
